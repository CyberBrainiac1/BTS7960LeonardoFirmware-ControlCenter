<UserControl x:Class="ArduinoFFBControlCenter.Views.FfbTuningView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:helpers="clr-namespace:ArduinoFFBControlCenter.Helpers">
    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="{StaticResource PagePadding}" helpers:PanelSpacing.Spacing="14">
            <TextBlock Style="{StaticResource SectionTitleText}" Text="FFB Tuning Studio" />
            <TextBlock Style="{StaticResource HelperText}"
                       Text="Commercial-style tuning flow: quick basic controls, advanced filters, and curve editing."
                       TextWrapping="Wrap" />

            <Border Style="{StaticResource CardSoft}" Padding="12">
                <TextBlock Text="{Binding SerialConfigNotice}" Style="{StaticResource HelperText}" />
            </Border>

            <TabControl>
                <TabItem Header="Basic">
                    <StackPanel Margin="0,12,0,0" helpers:PanelSpacing.Spacing="12">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="1.3*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Style="{StaticResource Card}">
                                <StackPanel helpers:PanelSpacing.Spacing="10">
                                    <TextBlock Style="{StaticResource SectionTitleText}" Text="Core Feel" />
                                    <TextBlock Style="{StaticResource HelperText}" Text="Start here for fast setup. Keep high strength locked until stability is good." />

                                    <TextBlock Text="Overall Strength" />
                                    <Slider Minimum="0" Maximum="{Binding StrengthMax}" Value="{Binding GeneralGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    <ProgressBar Height="6" Value="{Binding StrengthUnlockProgress}" Maximum="1" />
                                    <Button x:Name="UnlockStrengthButton"
                                            Content="Hold to unlock high strength"
                                            IsEnabled="{Binding CanUseSerialConfig}"
                                            Style="{StaticResource AccentButton}"
                                            PreviewMouseLeftButtonDown="UnlockStrength_OnMouseDown"
                                            PreviewMouseLeftButtonUp="UnlockStrength_OnMouseUp"
                                            MouseLeave="UnlockStrength_OnMouseUp" />

                                    <TextBlock Margin="0,8,0,0" Text="Mechanical Damping Ratio" />
                                    <Slider Minimum="0" Maximum="100" Value="{Binding MechanicalDampingRatio}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    <TextBlock Style="{StaticResource HelperText}" Text="Macro slider that blends damping + friction + inertia for beginner tuning." />

                                    <TextBlock Margin="0,8,0,0" Text="Steering Intensity" />
                                    <Slider Minimum="50" Maximum="150" Value="{Binding SteeringScale}" IsEnabled="{Binding CanUseSerialConfig}" />
                                </StackPanel>
                            </Border>

                            <Border Grid.Column="1" Style="{StaticResource Card}" Margin="16,0,0,0">
                                <StackPanel helpers:PanelSpacing.Spacing="10">
                                    <TextBlock Style="{StaticResource SectionTitleText}" Text="Live Preview" />
                                    <TextBlock Style="{StaticResource HelperText}" Text="Preview of torque mapping, useful before writing to wheel EEPROM." />

                                    <Viewbox Height="240">
                                        <Canvas Width="100" Height="100" Background="{StaticResource Surface2Brush}">
                                            <Polyline Points="{Binding PreviewPoints}" Stroke="{StaticResource AccentBrush}" StrokeThickness="2.6" />
                                        </Canvas>
                                    </Viewbox>

                                    <TextBlock Text="Smoothing Preview" />
                                    <Slider Minimum="0.05" Maximum="1.0" Value="{Binding PreviewSmoothing}" />

                                    <UniformGrid Columns="2" Margin="0,4,0,0">
                                        <StackPanel Margin="0,0,8,0">
                                            <TextBlock Text="Min Torque" />
                                            <Slider Minimum="0" Maximum="200" Value="{Binding MinTorque}" IsEnabled="{Binding CanUseSerialConfig}" />
                                        </StackPanel>
                                        <StackPanel Margin="8,0,0,0">
                                            <TextBlock Text="Min Force Boost" />
                                            <Slider Minimum="0" Maximum="50" Value="{Binding MinForceBoost}" IsEnabled="{Binding CanUseSerialConfig}" />
                                        </StackPanel>
                                    </UniformGrid>
                                </StackPanel>
                            </Border>
                        </Grid>

                        <Border Style="{StaticResource Card}">
                            <StackPanel helpers:PanelSpacing.Spacing="8">
                                <TextBlock Style="{StaticResource SectionTitleText}" Text="Detailed Effects" />
                                <UniformGrid Columns="3" Margin="0,4,0,0">
                                    <StackPanel Margin="0,0,12,10">
                                        <TextBlock Text="Spring" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding SpringGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,12,10">
                                        <TextBlock Text="Damper" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding DamperGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,0,10">
                                        <TextBlock Text="Friction" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding FrictionGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    </StackPanel>

                                    <StackPanel Margin="0,0,12,10">
                                        <TextBlock Text="Inertia" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding InertiaGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,12,10">
                                        <TextBlock Text="Centering" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding CenterGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,0,10">
                                        <TextBlock Text="Endstop" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding StopGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    </StackPanel>
                                </UniformGrid>
                            </StackPanel>
                        </Border>

                        <StackPanel Orientation="Horizontal" helpers:PanelSpacing.Spacing="8">
                            <Button Content="Load From Wheel" Command="{Binding LoadFromDeviceCommand}" IsEnabled="{Binding CanUseSerialConfig}" Style="{StaticResource PrimaryButton}" />
                            <Button Content="Apply" Command="{Binding ApplyCommand}" IsEnabled="{Binding CanUseSerialConfig}" Style="{StaticResource AccentButton}" />
                            <Button Content="Save to EEPROM" Command="{Binding SaveToDeviceCommand}" IsEnabled="{Binding CanSaveToEeprom}" Style="{StaticResource PrimaryButton}" />
                            <Button Content="Restore Previous" Command="{Binding RestorePreviousCommand}" IsEnabled="{Binding CanRestoreBackup}" Style="{StaticResource GhostButton}" />
                        </StackPanel>
                        <TextBlock Text="{Binding EepromNotice}" Style="{StaticResource HelperText}" />
                    </StackPanel>
                </TabItem>

                <TabItem Header="Advanced" IsEnabled="{Binding AdvancedEnabled}">
                    <StackPanel Margin="0,12,0,0" helpers:PanelSpacing.Spacing="12">
                        <Border Style="{StaticResource CardSoft}" Padding="12">
                            <TextBlock Text="{Binding AdvancedNotice}" Style="{StaticResource HelperText}" />
                        </Border>

                        <Border Style="{StaticResource Card}">
                            <StackPanel helpers:PanelSpacing.Spacing="8">
                                <TextBlock Style="{StaticResource SectionTitleText}" Text="Effect Equalizer" />
                                <UniformGrid Columns="4" Margin="0,2,0,0">
                                    <StackPanel Margin="0,0,10,8">
                                        <TextBlock Text="Overall" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding GeneralGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,10,8">
                                        <TextBlock Text="Constant" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding ConstantGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,10,8">
                                        <TextBlock Text="Periodic" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding PeriodicGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,0,8">
                                        <TextBlock Text="Spring" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding SpringGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,10,8">
                                        <TextBlock Text="Damper" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding DamperGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,10,8">
                                        <TextBlock Text="Friction" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding FrictionGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,10,8">
                                        <TextBlock Text="Inertia" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding InertiaGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,0,8">
                                        <TextBlock Text="Endstop" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding StopGain}" IsEnabled="{Binding CanUseSerialConfig}" />
                                    </StackPanel>
                                </UniformGrid>
                            </StackPanel>
                        </Border>

                        <Border Style="{StaticResource Card}">
                            <StackPanel helpers:PanelSpacing.Spacing="8">
                                <TextBlock Style="{StaticResource SectionTitleText}" Text="Filters and Safeguards" />
                                <UniformGrid Columns="3">
                                    <StackPanel Margin="0,0,10,8">
                                        <TextBlock Text="Slew Rate" />
                                        <Slider Minimum="0" Maximum="100" Value="{Binding SlewRate}" IsEnabled="{Binding AdvancedSupported}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,10,8">
                                        <TextBlock Text="Smoothing" />
                                        <Slider Minimum="0" Maximum="100" Value="{Binding Smoothing}" IsEnabled="{Binding AdvancedSupported}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,0,8">
                                        <TextBlock Text="Notch Filter" />
                                        <Slider Minimum="0" Maximum="100" Value="{Binding NotchFilter}" IsEnabled="{Binding AdvancedSupported}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,10,8">
                                        <TextBlock Text="Low-pass Filter" />
                                        <Slider Minimum="0" Maximum="100" Value="{Binding LowPassFilter}" IsEnabled="{Binding AdvancedSupported}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,10,8">
                                        <TextBlock Text="Soft Lock Strength" />
                                        <Slider Minimum="0" Maximum="200" Value="{Binding SoftLockStrength}" IsEnabled="{Binding AdvancedSupported}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,0,0,8">
                                        <TextBlock Text="Soft Lock Range" />
                                        <Slider Minimum="0" Maximum="1800" Value="{Binding SoftLockRange}" IsEnabled="{Binding AdvancedSupported}" />
                                    </StackPanel>
                                </UniformGrid>

                                <StackPanel Orientation="Horizontal" helpers:PanelSpacing.Spacing="8">
                                    <CheckBox Content="Oscillation Guard" IsChecked="{Binding OscillationGuardEnabled}" IsEnabled="{Binding AdvancedSupported}" />
                                    <TextBlock Text="Auto damping boost near center" Style="{StaticResource HelperText}" />
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <StackPanel Orientation="Horizontal" helpers:PanelSpacing.Spacing="8">
                            <Button Content="Load From Wheel" Command="{Binding LoadFromDeviceCommand}" IsEnabled="{Binding CanUseSerialConfig}" Style="{StaticResource PrimaryButton}" />
                            <Button Content="Apply Advanced" Command="{Binding ApplyCommand}" IsEnabled="{Binding CanUseSerialConfig}" Style="{StaticResource AccentButton}" />
                            <Button Content="Save to EEPROM" Command="{Binding SaveToDeviceCommand}" IsEnabled="{Binding CanSaveToEeprom}" Style="{StaticResource PrimaryButton}" />
                        </StackPanel>
                        <TextBlock Text="{Binding EepromNotice}" Style="{StaticResource HelperText}" />
                    </StackPanel>
                </TabItem>

                <TabItem Header="Curve">
                    <StackPanel Margin="0,12,0,0" helpers:PanelSpacing.Spacing="12">
                        <Border Style="{StaticResource Card}">
                            <StackPanel helpers:PanelSpacing.Spacing="10">
                                <TextBlock Style="{StaticResource SectionTitleText}" Text="FFB Curve Editor" />
                                <TextBlock Style="{StaticResource HelperText}" Text="Create a non-linear response curve like commercial wheel software." />

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="220" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0" helpers:PanelSpacing.Spacing="8">
                                        <ComboBox Style="{StaticResource FloatingComboBox}"
                                                  helpers:FloatingField.Label="Curve Type"
                                                  ItemsSource="{Binding CurveTypeOptions}"
                                                  SelectedItem="{Binding CurveType}" />
                                        <TextBlock Text="Curve Bias" />
                                        <Slider Minimum="0.1" Maximum="0.9" Value="{Binding CurveBias}" />

                                        <StackPanel Visibility="{Binding IsCustomCurve, Converter={StaticResource BoolToVisibility}}" helpers:PanelSpacing.Spacing="6">
                                            <TextBlock Text="Custom Point 25%" />
                                            <Slider Minimum="0" Maximum="1" Value="{Binding CurveCustomP1}" />
                                            <TextBlock Text="Custom Point 50%" />
                                            <Slider Minimum="0" Maximum="1" Value="{Binding CurveCustomP2}" />
                                            <TextBlock Text="Custom Point 75%" />
                                            <Slider Minimum="0" Maximum="1" Value="{Binding CurveCustomP3}" />
                                        </StackPanel>
                                    </StackPanel>

                                    <StackPanel Grid.Column="1" Margin="16,0,0,0" helpers:PanelSpacing.Spacing="8">
                                        <Border Style="{StaticResource CardSoft}" Padding="10">
                                            <Viewbox Height="260">
                                                <Canvas Width="100" Height="100" Background="{StaticResource Surface2Brush}">
                                                    <Polyline Points="{Binding CurvePoints}" Stroke="{StaticResource AccentBrush}" StrokeThickness="2.6" />
                                                </Canvas>
                                            </Viewbox>
                                        </Border>
                                        <TextBlock Text="{Binding CurveNotice}" Style="{StaticResource HelperText}" />
                                    </StackPanel>
                                </Grid>

                                <StackPanel Orientation="Horizontal" helpers:PanelSpacing.Spacing="8">
                                    <Button Content="Load Preset" Style="{StaticResource PrimaryButton}" />
                                    <Button Content="Export Preset" Style="{StaticResource PrimaryButton}" />
                                    <Button Content="Apply Curve" IsEnabled="{Binding CanApplyCurve}" Style="{StaticResource AccentButton}" />
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </TabItem>
            </TabControl>
        </StackPanel>
    </ScrollViewer>
</UserControl>
